

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>gpu_tracker.tracker &mdash; gpu_tracker 5.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=6a0c42bb"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            gpu_tracker
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">gpu_tracker</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">gpu_tracker.tracker</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for gpu_tracker.tracker</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;The ``tracker`` module contains the ``Tracker`` class which can alternatively be imported directly from the ``gpu_tracker`` package.&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dclass</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mproc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">typ</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">psutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">log</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pkl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">._helper_classes</span><span class="w"> </span><span class="kn">import</span> <span class="n">_NvidiaQuerier</span><span class="p">,</span> <span class="n">_AMDQuerier</span><span class="p">,</span> <span class="n">_DataProxy</span><span class="p">,</span> <span class="n">_TimepointUsage</span><span class="p">,</span> <span class="n">_StaticData</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_TrackingProcess</span><span class="p">(</span><span class="n">mproc</span><span class="o">.</span><span class="n">Process</span><span class="p">):</span>
    <span class="n">_CPU_PERCENT_INTERVAL</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">_ram_unit2coefficient</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;bytes&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="s1">&#39;kilobytes&#39;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
        <span class="s1">&#39;megabytes&#39;</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span>
        <span class="s1">&#39;gigabytes&#39;</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span>
        <span class="s1">&#39;terabytes&#39;</span><span class="p">:</span> <span class="mf">1e-12</span>
    <span class="p">}</span>
    <span class="n">_gpu_ram_unit2coefficient</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;bytes&#39;</span><span class="p">:</span> <span class="mf">1e6</span><span class="p">,</span>
        <span class="s1">&#39;kilobytes&#39;</span><span class="p">:</span> <span class="mf">1e3</span><span class="p">,</span>
        <span class="s1">&#39;megabytes&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="s1">&#39;gigabytes&#39;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
        <span class="s1">&#39;terabytes&#39;</span><span class="p">:</span> <span class="mf">1e-6</span>
    <span class="p">}</span>
    <span class="n">_time_unit2coefficient</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;seconds&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="s1">&#39;minutes&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span>
        <span class="s1">&#39;hours&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">),</span>
        <span class="s1">&#39;days&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">:</span> <span class="n">mproc</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span> <span class="n">sleep_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ram_unit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">gpu_ram_unit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">time_unit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">n_expected_cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gpu_uuids</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">disable_logs</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">main_process_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">resource_usage_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">extraneous_process_ids</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">gpu_brand</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tracking_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span> <span class="o">=</span> <span class="n">stop_event</span>
        <span class="k">if</span> <span class="n">sleep_time</span> <span class="o">&lt;</span> <span class="n">_TrackingProcess</span><span class="o">.</span><span class="n">_CPU_PERCENT_INTERVAL</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Sleep time of </span><span class="si">{</span><span class="n">sleep_time</span><span class="si">}</span><span class="s1"> is invalid. Must be at least </span><span class="si">{</span><span class="n">_TrackingProcess</span><span class="o">.</span><span class="n">_CPU_PERCENT_INTERVAL</span><span class="si">}</span><span class="s1"> seconds.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sleep_time</span> <span class="o">=</span> <span class="n">sleep_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ram_coefficient</span> <span class="o">=</span> <span class="n">_TrackingProcess</span><span class="o">.</span><span class="n">_validate_unit</span><span class="p">(</span>
            <span class="n">ram_unit</span><span class="p">,</span> <span class="n">_TrackingProcess</span><span class="o">.</span><span class="n">_ram_unit2coefficient</span><span class="p">,</span> <span class="n">unit_type</span><span class="o">=</span><span class="s1">&#39;RAM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gpu_ram_coefficient</span> <span class="o">=</span> <span class="n">_TrackingProcess</span><span class="o">.</span><span class="n">_validate_unit</span><span class="p">(</span>
            <span class="n">gpu_ram_unit</span><span class="p">,</span> <span class="n">_TrackingProcess</span><span class="o">.</span><span class="n">_gpu_ram_unit2coefficient</span><span class="p">,</span> <span class="n">unit_type</span><span class="o">=</span><span class="s1">&#39;GPU RAM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_coefficient</span> <span class="o">=</span> <span class="n">_TrackingProcess</span><span class="o">.</span><span class="n">_validate_unit</span><span class="p">(</span>
            <span class="n">time_unit</span><span class="p">,</span> <span class="n">_TrackingProcess</span><span class="o">.</span><span class="n">_time_unit2coefficient</span><span class="p">,</span> <span class="n">unit_type</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disable_logs</span> <span class="o">=</span> <span class="n">disable_logs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_main_process_id</span> <span class="o">=</span> <span class="n">main_process_id</span>
        <span class="n">percent_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cpu_system&#39;</span><span class="p">,</span> <span class="s1">&#39;cpu_main&#39;</span><span class="p">,</span> <span class="s1">&#39;cpu_descendants&#39;</span><span class="p">,</span> <span class="s1">&#39;cpu_combined&#39;</span><span class="p">,</span> <span class="s1">&#39;gpu&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sum_percent_sums</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="mf">0.</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">percent_keys</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hardware_percent_sums</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="mf">0.</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">percent_keys</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tracking_iteration</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_linux</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;linux&#39;</span>
        <span class="n">cannot_connect_warning</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The </span><span class="si">{}</span><span class="s1"> command is installed but cannot connect to a GPU. &#39;</span>
                                  <span class="s1">&#39;The GPU RAM and GPU utilization values will remain 0.0.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_proxy</span> <span class="o">=</span> <span class="n">_DataProxy</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">tracking_file</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gpu_brand</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nvidia_available</span> <span class="o">=</span> <span class="n">_NvidiaQuerier</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>
            <span class="n">nvidia_installed</span> <span class="o">=</span> <span class="n">nvidia_available</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">nvidia_available</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">nvidia_available</span><span class="p">)</span>
            <span class="n">amd_available</span> <span class="o">=</span> <span class="n">_AMDQuerier</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>
            <span class="n">amd_installed</span> <span class="o">=</span> <span class="n">amd_available</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">amd_available</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">amd_available</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nvidia_available</span><span class="p">:</span>
                <span class="n">gpu_brand</span> <span class="o">=</span> <span class="s1">&#39;nvidia&#39;</span>
            <span class="k">elif</span> <span class="n">amd_available</span><span class="p">:</span>
                <span class="n">gpu_brand</span> <span class="o">=</span> <span class="s1">&#39;amd&#39;</span>
            <span class="k">elif</span> <span class="n">nvidia_installed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_warning</span><span class="p">(</span><span class="n">cannot_connect_warning</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;nvidia-smi&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">amd_installed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_warning</span><span class="p">(</span><span class="n">cannot_connect_warning</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;amd-smi&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_warning</span><span class="p">(</span>
                    <span class="s1">&#39;Neither the nvidia-smi command nor the amd-smi command is installed. Install one of these to profile the GPU. &#39;</span>
                    <span class="s1">&#39;Otherwise the GPU RAM and GPU utilization values will remain 0.0.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gpu_brand</span> <span class="o">==</span> <span class="s1">&#39;nvidia&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gpu_querier</span> <span class="o">=</span> <span class="n">_NvidiaQuerier</span>
        <span class="k">elif</span> <span class="n">gpu_brand</span> <span class="o">==</span> <span class="s1">&#39;amd&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gpu_querier</span> <span class="o">=</span> <span class="n">_AMDQuerier</span>
        <span class="k">elif</span> <span class="n">gpu_brand</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gpu_querier</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">gpu_brand</span><span class="si">}</span><span class="s1">&quot; is not a valid GPU brand. Supported values are &quot;nvidia&quot; and &quot;amd&quot;.&#39;</span><span class="p">)</span>
        <span class="n">max_ram</span> <span class="o">=</span> <span class="n">MaxRAM</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">ram_unit</span><span class="p">,</span> <span class="n">system_capacity</span><span class="o">=</span><span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">total</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ram_coefficient</span><span class="p">)</span>
        <span class="n">system_core_count</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="n">cpu_utilization</span> <span class="o">=</span> <span class="n">CPUUtilization</span><span class="p">(</span>
            <span class="n">system_core_count</span><span class="o">=</span><span class="n">system_core_count</span><span class="p">,</span>
            <span class="n">n_expected_cores</span><span class="o">=</span><span class="n">n_expected_cores</span> <span class="k">if</span> <span class="n">n_expected_cores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">system_core_count</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gpu_querier</span><span class="p">:</span>
            <span class="n">gpu_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gpu_querier</span><span class="o">.</span><span class="n">static_info</span><span class="p">()</span>
            <span class="n">gpu_ram_system_capacity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gpu_ram</span><span class="p">(</span><span class="n">gpu_info</span><span class="o">=</span><span class="n">gpu_info</span><span class="p">)</span>
            <span class="n">max_gpu_ram</span> <span class="o">=</span> <span class="n">MaxGPURAM</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">gpu_ram_unit</span><span class="p">,</span> <span class="n">system_capacity</span><span class="o">=</span><span class="n">gpu_ram_system_capacity</span><span class="p">)</span>
            <span class="n">all_uuids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">gpu_info</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gpu_uuids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gpu_uuids</span> <span class="o">=</span> <span class="n">all_uuids</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpu_uuids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;gpu_uuids is not None but the set is empty. Please provide a set of at least one GPU UUID.&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">gpu_uuid</span> <span class="ow">in</span> <span class="n">gpu_uuids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">gpu_uuid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_uuids</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;GPU UUID of </span><span class="si">{</span><span class="n">gpu_uuid</span><span class="si">}</span><span class="s1"> is not valid. Available UUIDs are: </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_uuids</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gpu_uuids</span> <span class="o">=</span> <span class="n">gpu_uuids</span>
            <span class="n">gpu_utilization</span> <span class="o">=</span> <span class="n">GPUUtilization</span><span class="p">(</span><span class="n">system_gpu_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">all_uuids</span><span class="p">),</span> <span class="n">n_expected_gpus</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gpu_uuids</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_gpu_ram</span> <span class="o">=</span> <span class="n">MaxGPURAM</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">gpu_ram_unit</span><span class="p">,</span> <span class="n">system_capacity</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">gpu_utilization</span> <span class="o">=</span> <span class="n">GPUUtilization</span><span class="p">(</span><span class="n">system_gpu_count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_expected_gpus</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">compute_time</span> <span class="o">=</span> <span class="n">ComputeTime</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">time_unit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage</span> <span class="o">=</span> <span class="n">ResourceUsage</span><span class="p">(</span>
            <span class="n">max_ram</span><span class="o">=</span><span class="n">max_ram</span><span class="p">,</span> <span class="n">max_gpu_ram</span><span class="o">=</span><span class="n">max_gpu_ram</span><span class="p">,</span> <span class="n">cpu_utilization</span><span class="o">=</span><span class="n">cpu_utilization</span><span class="p">,</span> <span class="n">gpu_utilization</span><span class="o">=</span><span class="n">gpu_utilization</span><span class="p">,</span>
            <span class="n">compute_time</span><span class="o">=</span><span class="n">compute_time</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_proxy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">static_data</span> <span class="o">=</span> <span class="n">_StaticData</span><span class="p">(</span>
                <span class="n">ram_unit</span><span class="p">,</span> <span class="n">gpu_ram_unit</span><span class="p">,</span> <span class="n">time_unit</span><span class="p">,</span> <span class="n">max_ram</span><span class="o">.</span><span class="n">system_capacity</span><span class="p">,</span> <span class="n">max_gpu_ram</span><span class="o">.</span><span class="n">system_capacity</span><span class="p">,</span> <span class="n">system_core_count</span><span class="p">,</span>
                <span class="n">cpu_utilization</span><span class="o">.</span><span class="n">n_expected_cores</span><span class="p">,</span> <span class="n">gpu_utilization</span><span class="o">.</span><span class="n">system_gpu_count</span><span class="p">,</span> <span class="n">gpu_utilization</span><span class="o">.</span><span class="n">n_expected_gpus</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_proxy</span><span class="o">.</span><span class="n">write_static_data</span><span class="p">(</span><span class="n">static_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage_file</span> <span class="o">=</span> <span class="n">resource_usage_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extraneous_process_ids</span> <span class="o">=</span> <span class="n">extraneous_process_ids</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Continuously tracks computational resource usage until the end of tracking is triggered, either by exiting the context manager or by a call to stop()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extraneous_process_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">get_memory_maps</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">process</span><span class="p">:</span> <span class="n">process</span><span class="o">.</span><span class="n">memory_maps</span><span class="p">(</span><span class="n">grouped</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">get_rss</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">process</span><span class="p">:</span> <span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span>
        <span class="n">get_n_threads</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">process</span><span class="p">:</span> <span class="n">process</span><span class="o">.</span><span class="n">num_threads</span><span class="p">()</span>
        <span class="n">get_cpu_percent</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">process</span><span class="p">:</span> <span class="n">process</span><span class="o">.</span><span class="n">cpu_percent</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">main_process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_main_process_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">psutil</span><span class="o">.</span><span class="n">NoSuchProcess</span><span class="p">:</span>
            <span class="n">main_process</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The target process of ID </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_main_process_id</span><span class="si">}</span><span class="s1"> ended before tracking could begin.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="c1"># Simulate a do-while loop so that the tracking is executed at least once.</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">timepoint_usage</span> <span class="o">=</span> <span class="n">_TimepointUsage</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">pkl</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="c1"># Tracking has completed.</span>
                <span class="k">break</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">descendant_processes</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">process</span> <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">main_process</span><span class="o">.</span><span class="n">children</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">pid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extraneous_process_ids</span><span class="p">]</span>
                <span class="c1"># The first call to cpu_percent returns a meaningless value of 0.0 and should be ignored.</span>
                <span class="c1"># And it&#39;s recommended to wait a specified amount of time after the first call to cpu_percent.</span>
                <span class="c1"># See https://psutil.readthedocs.io/en/latest/#psutil.Process.cpu_percent</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_map_processes</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="p">[</span><span class="n">main_process</span><span class="p">]</span> <span class="o">+</span> <span class="n">descendant_processes</span><span class="p">,</span> <span class="n">map_func</span><span class="o">=</span><span class="n">get_cpu_percent</span><span class="p">)</span>
                <span class="c1"># Get the maximum RAM usage.</span>
                <span class="n">ram_map_func</span> <span class="o">=</span> <span class="n">get_memory_maps</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linux</span> <span class="k">else</span> <span class="n">get_rss</span>
                <span class="n">main_ram</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_processes</span><span class="p">([</span><span class="n">main_process</span><span class="p">],</span> <span class="n">map_func</span><span class="o">=</span><span class="n">ram_map_func</span><span class="p">)</span>
                <span class="n">descendants_ram</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_processes</span><span class="p">(</span><span class="n">descendant_processes</span><span class="p">,</span> <span class="n">map_func</span><span class="o">=</span><span class="n">ram_map_func</span><span class="p">)</span>
                <span class="n">combined_ram</span> <span class="o">=</span> <span class="n">main_ram</span> <span class="o">+</span> <span class="n">descendants_ram</span>
                <span class="n">kwarg</span> <span class="o">=</span> <span class="s1">&#39;memory_maps_list&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linux</span> <span class="k">else</span> <span class="s1">&#39;rss_list&#39;</span>
                <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">main_ram</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_ram</span><span class="p">(</span><span class="n">rss_values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage</span><span class="o">.</span><span class="n">max_ram</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="n">kwarg</span><span class="p">:</span> <span class="n">main_ram</span><span class="p">})</span>
                <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">descendants_ram</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_ram</span><span class="p">(</span>
                    <span class="n">rss_values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage</span><span class="o">.</span><span class="n">max_ram</span><span class="o">.</span><span class="n">descendants</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="n">kwarg</span><span class="p">:</span> <span class="n">descendants_ram</span><span class="p">})</span>
                <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">combined_ram</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_ram</span><span class="p">(</span>
                    <span class="n">rss_values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage</span><span class="o">.</span><span class="n">max_ram</span><span class="o">.</span><span class="n">combined</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="n">kwarg</span><span class="p">:</span> <span class="n">combined_ram</span><span class="p">})</span>
                <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">system_ram</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">used</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ram_coefficient</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage</span><span class="o">.</span><span class="n">max_ram</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage</span><span class="o">.</span><span class="n">max_ram</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">system_ram</span><span class="p">)</span>
                <span class="c1"># Get the maximum GPU RAM usage if available.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gpu_querier</span><span class="p">:</span>  <span class="c1"># pragma: nocover</span>
                    <span class="n">gpu_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gpu_querier</span><span class="o">.</span><span class="n">process_ram</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpu_info</span><span class="p">):</span>
                        <span class="n">process_ids</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_main_process_id</span><span class="p">}</span>
                        <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">main_gpu_ram</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_gpu_ram</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="n">process_ids</span><span class="o">=</span><span class="n">process_ids</span><span class="p">,</span> <span class="n">gpu_info</span><span class="o">=</span><span class="n">gpu_info</span><span class="p">)</span>
                        <span class="n">process_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_map_processes</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">descendant_processes</span><span class="p">,</span> <span class="n">map_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">process</span><span class="p">:</span> <span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="p">))</span>
                        <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">descendants_gpu_ram</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_gpu_ram</span><span class="p">(</span>
                            <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;descendants&#39;</span><span class="p">,</span> <span class="n">process_ids</span><span class="o">=</span><span class="n">process_ids</span><span class="p">,</span> <span class="n">gpu_info</span><span class="o">=</span><span class="n">gpu_info</span><span class="p">)</span>
                        <span class="n">process_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_main_process_id</span><span class="p">)</span>
                        <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">combined_gpu_ram</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_gpu_ram</span><span class="p">(</span>
                            <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;combined&#39;</span><span class="p">,</span> <span class="n">process_ids</span><span class="o">=</span><span class="n">process_ids</span><span class="p">,</span> <span class="n">gpu_info</span><span class="o">=</span><span class="n">gpu_info</span><span class="p">)</span>
                    <span class="n">gpu_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gpu_querier</span><span class="o">.</span><span class="n">ram_and_utilization</span><span class="p">()</span>
                    <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">system_gpu_ram</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gpu_ram</span><span class="p">(</span><span class="n">gpu_info</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage</span><span class="o">.</span><span class="n">max_gpu_ram</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage</span><span class="o">.</span><span class="n">max_gpu_ram</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">system_gpu_ram</span><span class="p">)</span>
                    <span class="n">gpu_info</span> <span class="o">=</span> <span class="n">gpu_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">uuid_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gpu_uuids</span> <span class="k">for</span> <span class="n">uuid_</span> <span class="ow">in</span> <span class="n">gpu_info</span><span class="o">.</span><span class="n">uuid</span><span class="p">]]</span>
                    <span class="p">(</span>
                        <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">gpu_sum_utilization_percent</span><span class="p">,</span> <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">gpu_hardware_utilization_percent</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_processing_unit_utilization</span><span class="p">(</span>
                        <span class="n">current_percentages</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">gpu_info</span><span class="o">.</span><span class="n">utilization_percent</span><span class="p">),</span>
                        <span class="n">processing_unit_percentages</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage</span><span class="o">.</span><span class="n">gpu_utilization</span><span class="o">.</span><span class="n">gpu_percentages</span><span class="p">,</span> <span class="n">percent_key</span><span class="o">=</span><span class="s1">&#39;gpu&#39;</span><span class="p">,</span>
                        <span class="n">n_hardware_units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage</span><span class="o">.</span><span class="n">gpu_utilization</span><span class="o">.</span><span class="n">n_expected_gpus</span><span class="p">)</span>
                <span class="c1"># Get the mean and maximum CPU usages.</span>
                <span class="n">main_n_threads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_processes</span><span class="p">([</span><span class="n">main_process</span><span class="p">],</span> <span class="n">map_func</span><span class="o">=</span><span class="n">get_n_threads</span><span class="p">)</span>
                <span class="n">descendant_n_threads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_processes</span><span class="p">(</span><span class="n">descendant_processes</span><span class="p">,</span> <span class="n">map_func</span><span class="o">=</span><span class="n">get_n_threads</span><span class="p">)</span>
                <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">main_n_threads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_n_threads</span><span class="p">(</span><span class="n">n_threads_list</span><span class="o">=</span><span class="n">main_n_threads</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
                <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">descendants_n_threads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_n_threads</span><span class="p">(</span>
                    <span class="n">n_threads_list</span><span class="o">=</span><span class="n">descendant_n_threads</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;descendants&#39;</span><span class="p">)</span>
                <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">combined_n_threads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_n_threads</span><span class="p">(</span>
                    <span class="n">n_threads_list</span><span class="o">=</span><span class="n">main_n_threads</span> <span class="o">+</span> <span class="n">descendant_n_threads</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;combined&#39;</span><span class="p">)</span>
                <span class="c1"># noinspection PyTypeChecker</span>
                <span class="n">system_core_percentages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_percent</span><span class="p">(</span><span class="n">percpu</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">cpu_utilization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage</span><span class="o">.</span><span class="n">cpu_utilization</span>
                <span class="p">(</span>
                    <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">cpu_system_sum_utilization_percent</span><span class="p">,</span> <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">cpu_system_hardware_utilization_percent</span>
                <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_processing_unit_utilization</span><span class="p">(</span>
                    <span class="n">current_percentages</span><span class="o">=</span><span class="n">system_core_percentages</span><span class="p">,</span> <span class="n">processing_unit_percentages</span><span class="o">=</span><span class="n">cpu_utilization</span><span class="o">.</span><span class="n">system</span><span class="p">,</span>
                    <span class="n">percent_key</span><span class="o">=</span><span class="s1">&#39;cpu_system&#39;</span><span class="p">,</span> <span class="n">n_hardware_units</span><span class="o">=</span><span class="n">cpu_utilization</span><span class="o">.</span><span class="n">system_core_count</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">_TrackingProcess</span><span class="o">.</span><span class="n">_CPU_PERCENT_INTERVAL</span><span class="p">)</span>
                <span class="n">main_percentage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_processes</span><span class="p">([</span><span class="n">main_process</span><span class="p">],</span> <span class="n">map_func</span><span class="o">=</span><span class="n">get_cpu_percent</span><span class="p">)</span>
                <span class="n">descendant_percentages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_processes</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">descendant_processes</span><span class="p">,</span> <span class="n">map_func</span><span class="o">=</span><span class="n">get_cpu_percent</span><span class="p">)</span>
                <span class="p">(</span>
                    <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">cpu_main_sum_utilization_percent</span><span class="p">,</span> <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">cpu_main_hardware_utilization_percent</span>
                <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_processing_unit_utilization</span><span class="p">(</span>
                    <span class="n">current_percentages</span><span class="o">=</span><span class="n">main_percentage</span><span class="p">,</span> <span class="n">processing_unit_percentages</span><span class="o">=</span><span class="n">cpu_utilization</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="n">percent_key</span><span class="o">=</span><span class="s1">&#39;cpu_main&#39;</span><span class="p">,</span>
                    <span class="n">n_hardware_units</span><span class="o">=</span><span class="n">cpu_utilization</span><span class="o">.</span><span class="n">n_expected_cores</span><span class="p">)</span>
                <span class="p">(</span>
                    <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">cpu_descendants_sum_utilization_percent</span><span class="p">,</span>
                    <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">cpu_descendants_hardware_utilization_percent</span>
                <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_processing_unit_utilization</span><span class="p">(</span>
                    <span class="n">current_percentages</span><span class="o">=</span><span class="n">descendant_percentages</span><span class="p">,</span> <span class="n">processing_unit_percentages</span><span class="o">=</span><span class="n">cpu_utilization</span><span class="o">.</span><span class="n">descendants</span><span class="p">,</span>
                    <span class="n">percent_key</span><span class="o">=</span><span class="s1">&#39;cpu_descendants&#39;</span><span class="p">,</span> <span class="n">n_hardware_units</span><span class="o">=</span><span class="n">cpu_utilization</span><span class="o">.</span><span class="n">n_expected_cores</span><span class="p">)</span>
                <span class="p">(</span>
                    <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">cpu_combined_sum_utilization_percent</span><span class="p">,</span>
                    <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">cpu_combined_hardware_utilization_percent</span>
                <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_processing_unit_utilization</span><span class="p">(</span>
                    <span class="n">current_percentages</span><span class="o">=</span><span class="n">main_percentage</span> <span class="o">+</span> <span class="n">descendant_percentages</span><span class="p">,</span> <span class="n">processing_unit_percentages</span><span class="o">=</span><span class="n">cpu_utilization</span><span class="o">.</span><span class="n">combined</span><span class="p">,</span>
                    <span class="n">percent_key</span><span class="o">=</span><span class="s1">&#39;cpu_combined&#39;</span><span class="p">,</span> <span class="n">n_hardware_units</span><span class="o">=</span><span class="n">cpu_utilization</span><span class="o">.</span><span class="n">n_expected_cores</span><span class="p">)</span>
                <span class="c1"># Update compute time.</span>
                <span class="n">timepoint_usage</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage</span><span class="o">.</span><span class="n">compute_time</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">timepoint_usage</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_coefficient</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tracking_iteration</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_proxy</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_proxy</span><span class="o">.</span><span class="n">write_data</span><span class="p">(</span><span class="n">timepoint_usage</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sleep_time</span> <span class="o">-</span> <span class="n">_TrackingProcess</span><span class="o">.</span><span class="n">_CPU_PERCENT_INTERVAL</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">psutil</span><span class="o">.</span><span class="n">NoSuchProcess</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed to track a process (PID: </span><span class="si">{</span><span class="n">error</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s1">) that does not exist. &#39;</span>
                                  <span class="sa">f</span><span class="s1">&#39;This possibly resulted from the process completing before it could be tracked.&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_warning</span><span class="p">(</span><span class="s1">&#39;The following uncaught exception occurred in the tracking process:&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_map_processes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">],</span> <span class="n">map_func</span><span class="p">:</span> <span class="n">typ</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">],</span> <span class="n">typ</span><span class="o">.</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">mapped_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">]()</span>
        <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mapped_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">map_func</span><span class="p">(</span><span class="n">process</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">psutil</span><span class="o">.</span><span class="n">NoSuchProcess</span><span class="p">:</span>  <span class="c1"># pragma: nocover</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_warning</span><span class="p">(</span><span class="s1">&#39;Attempted to obtain usage information of a process that no longer exists.&#39;</span><span class="p">)</span>  <span class="c1"># pragma: nocover</span>
        <span class="k">return</span> <span class="n">mapped_list</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_ram</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">rss_values</span><span class="p">:</span> <span class="n">RSSValues</span><span class="p">,</span> <span class="n">memory_maps_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rss_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">memory_maps_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">private_rss</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">path_to_shared_rss</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]()</span>
            <span class="k">for</span> <span class="n">memory_maps</span> <span class="ow">in</span> <span class="n">memory_maps_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">memory_map</span> <span class="ow">in</span> <span class="n">memory_maps</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">memory_map</span><span class="o">.</span><span class="n">path</span>
                    <span class="c1"># If the same memory map is shared by multiple processes, record the shared rss of the process using the most of it.</span>
                    <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">path_to_shared_rss</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">path_to_shared_rss</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">path_to_shared_rss</span><span class="p">[</span><span class="n">path</span><span class="p">],</span> <span class="n">memory_map</span><span class="o">.</span><span class="n">shared_dirty</span> <span class="o">+</span> <span class="n">memory_map</span><span class="o">.</span><span class="n">shared_clean</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">path_to_shared_rss</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">memory_map</span><span class="o">.</span><span class="n">shared_dirty</span> <span class="o">+</span> <span class="n">memory_map</span><span class="o">.</span><span class="n">shared_clean</span>
                    <span class="n">private_rss</span> <span class="o">+=</span> <span class="n">memory_map</span><span class="o">.</span><span class="n">private_dirty</span> <span class="o">+</span> <span class="n">memory_map</span><span class="o">.</span><span class="n">private_clean</span>
            <span class="n">private_rss</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ram_coefficient</span>
            <span class="n">rss_values</span><span class="o">.</span><span class="n">private_rss</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">rss_values</span><span class="o">.</span><span class="n">private_rss</span><span class="p">,</span> <span class="n">private_rss</span><span class="p">)</span>
            <span class="n">shared_rss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">path_to_shared_rss</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ram_coefficient</span>
            <span class="n">rss_values</span><span class="o">.</span><span class="n">shared_rss</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">rss_values</span><span class="o">.</span><span class="n">shared_rss</span><span class="p">,</span> <span class="n">shared_rss</span><span class="p">)</span>
            <span class="n">total_rss</span> <span class="o">=</span> <span class="n">private_rss</span> <span class="o">+</span> <span class="n">shared_rss</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">total_rss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">rss_list</span><span class="p">)</span>
            <span class="n">total_rss</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ram_coefficient</span>
        <span class="n">rss_values</span><span class="o">.</span><span class="n">total_rss</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">rss_values</span><span class="o">.</span><span class="n">total_rss</span><span class="p">,</span> <span class="n">total_rss</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">total_rss</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_gpu_ram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">process_ids</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">gpu_info</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">gpu_info</span> <span class="o">=</span> <span class="n">gpu_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">pid</span> <span class="ow">in</span> <span class="n">process_ids</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">gpu_info</span><span class="o">.</span><span class="n">pid</span><span class="p">]]</span>
        <span class="n">gpu_ram</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gpu_ram</span><span class="p">(</span><span class="n">gpu_info</span><span class="p">)</span>
        <span class="n">max_gpu_ram</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage</span><span class="o">.</span><span class="n">max_gpu_ram</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage</span><span class="o">.</span><span class="n">max_gpu_ram</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_gpu_ram</span><span class="p">,</span> <span class="n">gpu_ram</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">gpu_ram</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_gpu_ram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpu_info</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">gpu_info</span><span class="o">.</span><span class="n">ram</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gpu_ram_coefficient</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_processing_unit_utilization</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">current_percentages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">processing_unit_percentages</span><span class="p">:</span> <span class="n">ProcessingUnitPercentages</span><span class="p">,</span>
            <span class="n">percent_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n_hardware_units</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="n">sum_percent</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">current_percentages</span><span class="p">)</span>
        <span class="n">hardware_percent</span> <span class="o">=</span> <span class="n">sum_percent</span> <span class="o">/</span> <span class="n">n_hardware_units</span>
        <span class="k">for</span> <span class="n">percent</span><span class="p">,</span> <span class="n">percent_sums</span><span class="p">,</span> <span class="n">percent_type</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">sum_percent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_percent_sums</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">hardware_percent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hardware_percent_sums</span><span class="p">,</span> <span class="s1">&#39;hardware&#39;</span><span class="p">)):</span>
            <span class="n">percent_sums</span><span class="p">[</span><span class="n">percent_key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">percent</span>
            <span class="n">mean_percent</span> <span class="o">=</span> <span class="n">percent_sums</span><span class="p">[</span><span class="n">percent_key</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tracking_iteration</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">processing_unit_percentages</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;mean_</span><span class="si">{</span><span class="n">percent_type</span><span class="si">}</span><span class="s1">_percent&#39;</span><span class="p">,</span> <span class="n">mean_percent</span><span class="p">)</span>
            <span class="n">max_percent</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">processing_unit_percentages</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;max_</span><span class="si">{</span><span class="n">percent_type</span><span class="si">}</span><span class="s1">_percent&#39;</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">processing_unit_percentages</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;max_</span><span class="si">{</span><span class="n">percent_type</span><span class="si">}</span><span class="s1">_percent&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_percent</span><span class="p">,</span> <span class="n">percent</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">sum_percent</span><span class="p">,</span> <span class="n">hardware_percent</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_n_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_threads_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">n_threads</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">n_threads_list</span><span class="p">)</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1">_n_threads&#39;</span>
        <span class="n">max_n_threads</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage</span><span class="o">.</span><span class="n">cpu_utilization</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage</span><span class="o">.</span><span class="n">cpu_utilization</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">n_threads</span><span class="p">,</span> <span class="n">max_n_threads</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">n_threads</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">unit2coefficient</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">unit_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">valid_units</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">unit2coefficient</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_units</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s1">&quot; is not a valid </span><span class="si">{</span><span class="n">unit_type</span><span class="si">}</span><span class="s1"> unit. Valid values are </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">valid_units</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">unit2coefficient</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warning</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disable_logs</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>


<div class="viewcode-block" id="Tracker">
<a class="viewcode-back" href="../../api.html#gpu_tracker.tracker.Tracker">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Tracker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs a sub-process that tracks computational resources of the calling process. Including the compute time, maximum CPU utilization, mean CPU utilization, maximum RAM, and maximum GPU RAM used within a context manager or explicit calls to ``start()`` and ``stop()`` methods.</span>
<span class="sd">    Calculated quantities are scaled, depending on the units chosen for them (e.g. megabytes vs. gigabytes, hours vs. days, etc.).</span>

<span class="sd">    :ivar ResourceUsage resource_usage: Data class containing the computational resource usage data collected by the tracking process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_USAGE_FILE_TIME_DIFFERENCE</span> <span class="o">=</span> <span class="mf">10.0</span>

<div class="viewcode-block" id="Tracker.State">
<a class="viewcode-back" href="../../api.html#gpu_tracker.tracker.Tracker.State">[docs]</a>
    <span class="k">class</span><span class="w"> </span><span class="nc">State</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The state of the Tracker.&quot;&quot;&quot;</span>
        <span class="n">NEW</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">STARTED</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">STOPPED</span> <span class="o">=</span> <span class="mi">2</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">sleep_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">ram_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;gigabytes&#39;</span><span class="p">,</span> <span class="n">gpu_ram_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;gigabytes&#39;</span><span class="p">,</span> <span class="n">time_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;hours&#39;</span><span class="p">,</span>
            <span class="n">n_expected_cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gpu_uuids</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">disable_logs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">process_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">resource_usage_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n_join_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">join_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
            <span class="n">gpu_brand</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tracking_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param sleep_time: The number of seconds to sleep in between usage-collection iterations.</span>
<span class="sd">        :param ram_unit: One of &#39;bytes&#39;, &#39;kilobytes&#39;, &#39;megabytes&#39;, &#39;gigabytes&#39;, or &#39;terabytes&#39;.</span>
<span class="sd">        :param gpu_ram_unit: One of &#39;bytes&#39;, &#39;kilobytes&#39;, &#39;megabytes&#39;, &#39;gigabytes&#39;, or &#39;terabytes&#39;.</span>
<span class="sd">        :param time_unit: One of &#39;seconds&#39;, &#39;minutes&#39;, &#39;hours&#39;, or &#39;days&#39;.</span>
<span class="sd">        :param n_expected_cores: The number of cores expected to be used during tracking (e.g. number of processes spawned, number of parallelized threads, etc.). Used as the denominator when calculating the hardware percentages of the CPU utilization (except for system-wide CPU utilization which always divides by all the cores in the system). Defaults to all the cores in the system.</span>
<span class="sd">        :param gpu_uuids: The UUIDs of the GPUs to track utilization for. The length of this set is used as the denominator when calculating the hardware percentages of the GPU utilization (i.e. n_expected_gpus). Defaults to all the GPUs in the system.</span>
<span class="sd">        :param disable_logs: If set, warnings are suppressed during tracking. Otherwise, the Tracker logs warnings as usual.</span>
<span class="sd">        :param process_id: The ID of the process to track. Defaults to the current process.</span>
<span class="sd">        :param resource_usage_file: The file path to the pickle file containing the ``resource_usage`` attribute. This file is automatically deleted and the ``resource_usage`` attribute is set in memory if the tracking successfully completes. But if the tracking is interrupted, the tracking information will be saved in this file as a backup. Defaults to a randomly generated file name in the current working directory of the format ``.gpu-tracker_&lt;random UUID&gt;.pkl``.</span>
<span class="sd">        :param n_join_attempts: The number of times the tracker attempts to join its underlying sub-process.</span>
<span class="sd">        :param join_timeout: The amount of time the tracker waits for its underlying sub-process to join.</span>
<span class="sd">        :param gpu_brand: The brand of GPU to profile. Valid values are &quot;nvidia&quot; and &quot;amd&quot;. Defaults to the brand of GPU detected in the system, checking Nvidia first.</span>
<span class="sd">        :param tracking_file: If specified, stores the individual resource usage measurements at each iteration. Valid file formats are CSV (.csv) and SQLite (.sqlite) where the SQLite file format stores the data in a table called &quot;data&quot; and allows for more efficient querying.</span>
<span class="sd">        :param overwrite: Whether to overwrite the ``tracking_file`` if it already existed before the beginning of this tracking session.</span>
<span class="sd">        :raises ValueError: Raised if invalid arguments are provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_process_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="n">current_process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">current_process_id</span><span class="p">)</span>
        <span class="c1"># Sometimes a &quot;resource tracker&quot; process is started after creating an Event object.</span>
        <span class="c1"># We want to exclude the resource tracker process(es) from the processes being tracked if it&#39;s (they&#39;re) created.</span>
        <span class="c1"># See https://docs.python.org/3/library/multiprocessing.html#contexts-and-start-methods</span>
        <span class="n">legit_child_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">process</span><span class="o">.</span><span class="n">pid</span> <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">current_process</span><span class="o">.</span><span class="n">children</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span> <span class="o">=</span> <span class="n">mproc</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="n">extraneous_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">process</span><span class="o">.</span><span class="n">pid</span> <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">current_process</span><span class="o">.</span><span class="n">children</span><span class="p">()}</span> <span class="o">-</span> <span class="n">legit_child_ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;.gpu-tracker_</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">()</span><span class="si">}</span><span class="s1">.pkl&#39;</span> <span class="k">if</span> <span class="n">resource_usage_file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">resource_usage_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tracking_process</span> <span class="o">=</span> <span class="n">_TrackingProcess</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span><span class="p">,</span> <span class="n">sleep_time</span><span class="p">,</span> <span class="n">ram_unit</span><span class="p">,</span> <span class="n">gpu_ram_unit</span><span class="p">,</span> <span class="n">time_unit</span><span class="p">,</span> <span class="n">n_expected_cores</span><span class="p">,</span> <span class="n">gpu_uuids</span><span class="p">,</span> <span class="n">disable_logs</span><span class="p">,</span>
            <span class="n">process_id</span> <span class="k">if</span> <span class="n">process_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">current_process_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage_file</span><span class="p">,</span> <span class="n">extraneous_ids</span><span class="p">,</span> <span class="n">gpu_brand</span><span class="p">,</span>
            <span class="n">tracking_file</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_usage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_join_attempts</span> <span class="o">=</span> <span class="n">n_join_attempts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join_timeout</span> <span class="o">=</span> <span class="n">join_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">Tracker</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">NEW</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;State: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tracker</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">Tracker</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">STARTED</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Cannot start tracking when tracking has already started.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">Tracker</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">STOPPED</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Cannot start tracking when tracking has already stopped.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">Tracker</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">STARTED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tracking_process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">Tracker</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">NEW</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Cannot stop tracking when tracking has not started yet.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">Tracker</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">STOPPED</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Cannot stop tracking when tracking has already stopped.&#39;</span><span class="p">)</span>
        <span class="n">n_join_attempts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">n_join_attempts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_join_attempts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tracking_process</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">join_timeout</span><span class="p">)</span>
            <span class="n">n_join_attempts</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tracking_process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The tracking process is still alive after join timout. Attempting to join again...&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tracking_process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;The tracking process is still alive after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_join_attempts</span><span class="si">}</span><span class="s1"> attempts to join. &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;Terminating the process by force...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tracking_process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tracking_process</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resource_usage</span> <span class="o">=</span> <span class="n">pkl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">time_since_modified</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">time_since_modified</span> <span class="o">&gt;</span> <span class="n">Tracker</span><span class="o">.</span><span class="n">_USAGE_FILE_TIME_DIFFERENCE</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Tracking is stopping and it has been </span><span class="si">{</span><span class="n">time_since_modified</span><span class="si">}</span><span class="s1"> seconds since the temporary tracking results file was &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;last updated. Resource usage was not updated during that time.&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource_usage_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;The temporary tracking results file does not exist. Tracking results cannot be obtained.&#39;</span><span class="p">)</span>  <span class="c1"># pragma: nocover</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">Tracker</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">STOPPED</span>

<div class="viewcode-block" id="Tracker.start">
<a class="viewcode-back" href="../../api.html#gpu_tracker.tracker.Tracker.start">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Begins tracking for the duration of time until ``stop()`` is called. Equivalent to entering the context manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span></div>


<div class="viewcode-block" id="Tracker.stop">
<a class="viewcode-back" href="../../api.html#gpu_tracker.tracker.Tracker.stop">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop tracking. Equivalent to exiting the context manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">()</span></div>


<div class="viewcode-block" id="Tracker.__str__">
<a class="viewcode-back" href="../../api.html#gpu_tracker.tracker.Tracker.__str__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs a string representation of the computational-resource-usage measurements and their units.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tracker_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
        <span class="n">Tracker</span><span class="o">.</span><span class="n">_format_float</span><span class="p">(</span><span class="n">dictionary</span><span class="o">=</span><span class="n">tracker_json</span><span class="p">)</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">tracker_json</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>
        <span class="c1"># Un-indent the lines to the left after removing curley braces.</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">indent</span><span class="p">:]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">,</span> <span class="s1">&#39;},&#39;</span><span class="p">})</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;: {&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;Max&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;ram&#39;</span><span class="p">,</span> <span class="s1">&#39;RAM&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">,</span> <span class="s1">&#39;Unit&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;System&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s1">&#39;compute&#39;</span><span class="p">,</span> <span class="s1">&#39;Compute&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;time: &#39;</span><span class="p">,</span> <span class="s1">&#39;Time: &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;rss&#39;</span><span class="p">,</span> <span class="s1">&#39;RSS&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="s1">&#39;Total&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s1">&#39;private&#39;</span><span class="p">,</span> <span class="s1">&#39;Private&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;shared&#39;</span><span class="p">,</span> <span class="s1">&#39;Shared&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;Main&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;descendants&#39;</span><span class="p">,</span> <span class="s1">&#39;Descendants&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s1">&#39;combined&#39;</span><span class="p">,</span> <span class="s1">&#39;Combined&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;gpu&#39;</span><span class="p">,</span> <span class="s1">&#39;GPU&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;Mean&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="s1">&#39;CPU&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s1">&#39;n threads&#39;</span><span class="p">,</span> <span class="s1">&#39;number of threads&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;n expected&#39;</span><span class="p">,</span> <span class="s1">&#39;Number of expected&#39;</span><span class="p">)</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_format_float</span><span class="p">(</span><span class="n">dictionary</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursively formats the floating points in a dictionary to 3 decimal places.</span>
<span class="sd">        :param dictionary: The dictionary to format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">Tracker</span><span class="o">.</span><span class="n">_format_float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="Tracker.to_json">
<a class="viewcode-back" href="../../api.html#gpu_tracker.tracker.Tracker.to_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs a dictionary of the computational-resource-usage measurements and their units.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_usage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s1">&#39;Cannot display the tracker in string or JSON format before tracking completes. Exit the content manager or call the &#39;</span>
                <span class="s1">&#39;stop() method before calling to_json() or str()&#39;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">dclass</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_usage</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="RSSValues">
<a class="viewcode-back" href="../../api.html#gpu_tracker.tracker.RSSValues">[docs]</a>
<span class="nd">@dclass</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RSSValues</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The resident set size (RSS) i.e. memory used by a process or processes.</span>

<span class="sd">    :param total_rss: The sum of ``private_rss`` and ``shared_rss``.</span>
<span class="sd">    :param private_rss: The RAM usage exclusive to a process.</span>
<span class="sd">    :param shared_rss: The RAM usage of a process shared with at least one other process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">total_rss</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">private_rss</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">shared_rss</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span></div>



<div class="viewcode-block" id="MaxRAM">
<a class="viewcode-back" href="../../api.html#gpu_tracker.tracker.MaxRAM">[docs]</a>
<span class="nd">@dclass</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MaxRAM</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Information related to RAM including the maximum RAM used over a period of time.</span>

<span class="sd">    :param unit: The unit of measurement for RAM e.g. gigabytes.</span>
<span class="sd">    :param system_capacity: A constant value for the RAM capacity of the entire operating system.</span>
<span class="sd">    :param system: The RAM usage across the entire operating system.</span>
<span class="sd">    :param main: The RAM usage of the main process.</span>
<span class="sd">    :param descendants: The summed RAM usage of the descendant processes (i.e. child processes, grandchild processes, etc.).</span>
<span class="sd">    :param combined: The summed RAM usage of both the main process and any descendant processes it may have.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">system_capacity</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">system</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">main</span><span class="p">:</span> <span class="n">RSSValues</span> <span class="o">=</span> <span class="n">dclass</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">RSSValues</span><span class="p">)</span>
    <span class="n">descendants</span><span class="p">:</span> <span class="n">RSSValues</span> <span class="o">=</span> <span class="n">dclass</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">RSSValues</span><span class="p">)</span>
    <span class="n">combined</span><span class="p">:</span> <span class="n">RSSValues</span> <span class="o">=</span> <span class="n">dclass</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">RSSValues</span><span class="p">)</span></div>



<div class="viewcode-block" id="MaxGPURAM">
<a class="viewcode-back" href="../../api.html#gpu_tracker.tracker.MaxGPURAM">[docs]</a>
<span class="nd">@dclass</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MaxGPURAM</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Information related to GPU RAM including the maximum GPU RAM used over a period of time.</span>

<span class="sd">    :param unit: The unit of measurement for GPU RAM e.g. gigabytes.</span>
<span class="sd">    :param system_capacity: A constant value for the GPU RAM capacity of all the GPUs in the system.</span>
<span class="sd">    :param system: The GPU RAM usage of all the GPUs in the system.</span>
<span class="sd">    :param main: The GPU RAM usage of the main process.</span>
<span class="sd">    :param descendants: The summed GPU RAM usage of the descendant processes (i.e. child processes, grandchild processes, etc.).</span>
<span class="sd">    :param combined: The summed GPU RAM usage of both the main process and any descendant processes it may have.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">system_capacity</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">system</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">main</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">descendants</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">combined</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span></div>



<div class="viewcode-block" id="ProcessingUnitPercentages">
<a class="viewcode-back" href="../../api.html#gpu_tracker.tracker.ProcessingUnitPercentages">[docs]</a>
<span class="nd">@dclass</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ProcessingUnitPercentages</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Utilization percentages of one or more processing units (i.e. GPUs or CPU cores).</span>
<span class="sd">    Max refers to the highest value measured over a duration of time.</span>
<span class="sd">    Mean refers to the average of the measured values during this time.</span>
<span class="sd">    Sum refers to the sum of the percentages of the processing units involved. If there is only one unit in question, this is the percentage of just that unit.</span>
<span class="sd">    Hardware refers to this sum divided by the number of units involved. If there is only one unit in question, this is the same as the sum.</span>

<span class="sd">    :param max_sum_percent: The maximum sum of utilization percentages of the processing units at any given time.</span>
<span class="sd">    :param max_hardware_percent: The maximum utilization percentage of the group of units as a whole (i.e. max_sum_percent divided by the number of units involved).</span>
<span class="sd">    :param mean_sum_percent: The mean sum of utilization percentages of the processing units used by the process(es) over time.</span>
<span class="sd">    :param mean_hardware_percent: The mean utilization percentage of the group of units as a whole (i.e. mean_sum_percent divided by the number of units involved).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_sum_percent</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">max_hardware_percent</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">mean_sum_percent</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">mean_hardware_percent</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span></div>



<div class="viewcode-block" id="CPUUtilization">
<a class="viewcode-back" href="../../api.html#gpu_tracker.tracker.CPUUtilization">[docs]</a>
<span class="nd">@dclass</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CPUUtilization</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Information related to CPU usage, including core utilization percentages of the main process and any descendant processes it may have as well as system-wide utilization.</span>
<span class="sd">    The system hardware utilization percentages are strictly divided by the total number of cores in the system while that of the main, descendant, and combined processes can be divided by the expected number of cores used in a task.</span>

<span class="sd">    :param system_core_count: The number of cores available to the entire operating system.</span>
<span class="sd">    :param n_expected_cores: The number of cores expected to be used by the main process and/or any descendant processes it may have.</span>
<span class="sd">    :param system: The utilization percentages of all the cores in the entire operating system.</span>
<span class="sd">    :param main: The utilization percentages of the cores used by the main process.</span>
<span class="sd">    :param descendants: The utilization percentages summed across descendant processes (i.e. child processes, grandchild processes, etc.).</span>
<span class="sd">    :param combined: The utilization percentages summed across both the descendant processes and the main process.</span>
<span class="sd">    :param main_n_threads: The maximum detected number of threads used by the main process at any time.</span>
<span class="sd">    :param descendants_n_threads: The maximum sum of threads used across the descendant processes at any time.</span>
<span class="sd">    :param combined_n_threads: The maximum sum of threads used by both the main and descendant processes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">system_core_count</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">n_expected_cores</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">system</span><span class="p">:</span> <span class="n">ProcessingUnitPercentages</span> <span class="o">=</span> <span class="n">dclass</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">ProcessingUnitPercentages</span><span class="p">)</span>
    <span class="n">main</span><span class="p">:</span> <span class="n">ProcessingUnitPercentages</span> <span class="o">=</span> <span class="n">dclass</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">ProcessingUnitPercentages</span><span class="p">)</span>
    <span class="n">descendants</span><span class="p">:</span> <span class="n">ProcessingUnitPercentages</span> <span class="o">=</span> <span class="n">dclass</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">ProcessingUnitPercentages</span><span class="p">)</span>
    <span class="n">combined</span><span class="p">:</span> <span class="n">ProcessingUnitPercentages</span> <span class="o">=</span> <span class="n">dclass</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">ProcessingUnitPercentages</span><span class="p">)</span>
    <span class="n">main_n_threads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">descendants_n_threads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">combined_n_threads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></div>



<div class="viewcode-block" id="GPUUtilization">
<a class="viewcode-back" href="../../api.html#gpu_tracker.tracker.GPUUtilization">[docs]</a>
<span class="nd">@dclass</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">GPUUtilization</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Utilization percentages of one or more GPUs being tracked.</span>
<span class="sd">    Hardware percentages are the summed percentages divided by the number of GPUs being tracked.</span>

<span class="sd">    :param system_gpu_count: The number of GPUs in the system.</span>
<span class="sd">    :param n_expected_gpus: The number of GPUs to be tracked (e.g. GPUs actually used while there may be other GPUs in the system).</span>
<span class="sd">    :param gpu_percentages: The utilization percentages of the GPU(s) being tracked.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">system_gpu_count</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">n_expected_gpus</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">gpu_percentages</span><span class="p">:</span> <span class="n">ProcessingUnitPercentages</span> <span class="o">=</span> <span class="n">dclass</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">ProcessingUnitPercentages</span><span class="p">)</span></div>



<div class="viewcode-block" id="ComputeTime">
<a class="viewcode-back" href="../../api.html#gpu_tracker.tracker.ComputeTime">[docs]</a>
<span class="nd">@dclass</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ComputeTime</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The time it takes for a task to complete.</span>

<span class="sd">    :param unit: The unit of measurement for compute time e.g. hours.</span>
<span class="sd">    :param time: The real compute time.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span></div>



<div class="viewcode-block" id="ResourceUsage">
<a class="viewcode-back" href="../../api.html#gpu_tracker.tracker.ResourceUsage">[docs]</a>
<span class="nd">@dclass</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ResourceUsage</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Contains data for computational resource usage.</span>

<span class="sd">    :param max_ram: The maximum RAM used at any point while tracking.</span>
<span class="sd">    :param max_gpu_ram: The maximum GPU RAM used at any point while tracking.</span>
<span class="sd">    :param cpu_utilization: Core counts, utilization percentages of cores and maximum number of threads used while tracking.</span>
<span class="sd">    :param gpu_utilization: GPU counts and utilization percentages of the GPU(s).</span>
<span class="sd">    :param compute_time: The real time spent tracking.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_ram</span><span class="p">:</span> <span class="n">MaxRAM</span>
    <span class="n">max_gpu_ram</span><span class="p">:</span> <span class="n">MaxGPURAM</span>
    <span class="n">cpu_utilization</span><span class="p">:</span> <span class="n">CPUUtilization</span>
    <span class="n">gpu_utilization</span><span class="p">:</span> <span class="n">GPUUtilization</span>
    <span class="n">compute_time</span><span class="p">:</span> <span class="n">ComputeTime</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Erik D. Huckvale, Hunter N. B. Moseley.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>